<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Adding OpenSSL bindings to Racket via its FFI</title>
    <meta name="description" content="C programming has its uses but it's also sometimes nice to program with a higher-level language where you don't need to constantly worry about things like overflow or freeing memory. I enjoy using Racket, a LISP dialect, when experimenting with Bitcoin. Unfortunately, Racket doesn't have a complete crypto librar.It does have, however, an FFI that enables Racket code to directly call C functions. In this post, I create Racket bindings for two important hashing functions used by Bitcoin, SHA-256 and RIPEMD-160. ...">
    <meta name="author"      content="The Unknown Blogger">
    <meta name="keywords"    content="OpenSSL, C, Racket, FFI, hashes, SHA, RIPEMD">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.ico">
    <link rel="canonical" href="http://www.lostintransaction.com/blog/2014/03/15/adding-openssl-bindings-to-racket-via-its-ffi/">
    <link rel="next" href="/blog/2014/03/14/deriving-a-bitcoin-public-key-from-a-private-key/">

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <!-- Feeds -->
    <link ref="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link ref="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-48721117-3']);
      _gaq.push(['_setDomainName', 'www.lostintransaction.com']);
      _gaq.push(['_trackPageview']);
      setTimeout(function(){_gaq.push(['_trackEvent', '30_seconds', 'read'])}, 30000); // http://drawingablank.me/blog/fix-your-bounce-rate.html
      (function() {
          var ga = document.createElement('script');
          ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <!-- A standard Twitter Bootstrap nav bar -->
    <header class="navbar navbar-default navbar-inverse"
            role="banner">
      <div class="container">
        <div class="navbar-header">
          <button type="button"
                  class="navbar-toggle"
                  data-toggle="collapse"
                  data-target=".our-nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="/index.html" class="navbar-brand">Lost in Transaction</a>
        </div>
        <div class="collapse navbar-collapse our-nav-collapse"
             role="navigation">
          <ul class="nav navbar-nav">

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="/index.html">All Posts</a></li>

<li><a href="/tags/Andreas-Antonopoulos.html">Andreas Antonopoulos</a></li>

<li><a href="/tags/C.html">C</a></li>

<li><a href="/tags/elliptic-curve.html">elliptic curve</a></li>

<li><a href="/tags/FFI.html">FFI</a></li>

<li><a href="/tags/hashes.html">hashes</a></li>

<li><a href="/tags/MultiBit.html">MultiBit</a></li>

<li><a href="/tags/OpenSSL.html">OpenSSL</a></li>

<li><a href="/tags/private-key.html">private key</a></li>

<li><a href="/tags/public-key.html">public key</a></li>

<li><a href="/tags/Racket.html">Racket</a></li>

<li><a href="/tags/RIPEMD.html">RIPEMD</a></li>

<li><a href="/tags/SHA.html">SHA</a></li>

<li><a href="/tags/signatures.html">signatures</a></li>
              </ul>
            </li>
            <li>
              <a href="/About.html">About</a>
            </li> 
            <li><a href="/feeds/all.atom.xml">Atom</a></li>
            <li><a href="/feeds/all.rss.xml">RSS</a></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row">

        <!-- Main column -->
        <div id="content" class="col-md-12">






<article>

 <header>

  <h1>Adding OpenSSL bindings to Racket via its FFI</h1>

  <p class="date-and-tags">
   <time datetime="2014-03-15" pubdate="true">2014-03-15</time> :: <span class="tags"><a href="/tags/OpenSSL.html">OpenSSL</a>, <a href="/tags/C.html">C</a>, <a href="/tags/Racket.html">Racket</a>, <a href="/tags/FFI.html">FFI</a>, <a href="/tags/hashes.html">hashes</a>, <a href="/tags/SHA.html">SHA</a>, <a href="/tags/RIPEMD.html">RIPEMD</a></span></p>
  </header>


 <p>C programming has its uses but it&rsquo;s also sometimes nice to program with a higher-level language where you don&rsquo;t need to constantly worry about things like overflow or freeing memory. I enjoy using <a href="http://racket-lang.org">Racket</a>, a LISP dialect, when experimenting with Bitcoin.</p>


 <p>Unfortunately, Racket doesn&rsquo;t have a complete crypto librar.It does have, however, an <a href="http://docs.racket-lang.org/foreign/index.html" title="Racket FFI">FFI</a> that enables Racket code to directly call C functions. In this post, I create Racket bindings for two important hashing functions used by Bitcoin, <a href="http://en.wikipedia.org/wiki/SHA-2" title="Wikipedia: SHA-2">SHA&ndash;256</a> and <a href="http://en.wikipedia.org/wiki/RIPEMD" title="Wikipedia: RIPEMD">RIPEMD&ndash;160</a>.</p>


 <h3 id="ffi-lib"><code>ffi-lib</code></h3>


 <p>The <a href="http://docs.racket-lang.org/foreign/Loading_Foreign_Libraries.html?q=ffi-lib#%28def._%28%28lib._ffi%2Funsafe..rkt%29._ffi-lib%29%29" title="Racket docs: ffi-lib"><code>ffi-lib</code></a> Racket function in the <code>ffi/unsafe</code> module creates a Racket value that represents the given C library. Racket actually already defines <a href="https://github.com/plt/racket/blob/8b4c5d3debbe41c90e37e5ffdc55fb8ab3635f92/racket/collects/openssl/libcrypto.rkt" title="Racket source: openssl/libcrypto.rkt">a <code>libcrypto</code> identifier</a>, which represents the OpenSSL <code>libcrypto</code> library (Racket has wrapper functions for some <code>libcrypto</code> C functions, but not for <code>SHA256</code> or <code>RIPEMD160</code>). Here&rsquo;s how to define a Racket value representing the <code>libcrypto</code> library using <code>ffi-lib</code>:</p>


 <div class="brush: racket">

  <table class="sourcetable">

   <tbody>

    <tr>

     <td class="linenos">

      <div class="linenodiv">

       <pre>1
2</pre></div></td>

     <td class="code">

      <div class="source">

       <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a> </span><span class="nv">libcrypto</span>
  <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/Loading_Foreign_Libraries.html#(def._((lib._ffi/unsafe..rkt)._ffi-lib))" style="color: inherit">ffi-lib</a></span> <span class="o">'</span><span class="p">(</span><span class="nv">so</span> <span class="s">"libcrypto"</span><span class="p">)</span> <span class="o">'</span><span class="p">(</span><span class="s">""</span> <span class="s">"1.0.1e"</span> <span class="s">"1.0.0"</span> <span class="s">"1.0"</span> <span class="s">"0.9.8b"</span> <span class="s">"0.9.8"</span> <span class="s">"0.9.7"</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>


 <p>The first argument specifies a dynamic C library and the second argument is a list of acceptable versions. See the documentation for <a href="http://docs.racket-lang.org/foreign/Loading_Foreign_Libraries.html?q=ffi-lib#%28def._%28%28lib._ffi%2Funsafe..rkt%29._ffi-lib%29%29" title="Racket docs: ffi-lib"><code>ffi-lib</code></a> for more details on its usage.</p>


 <h3 id="get-ffi-obj"><code>get-ffi-obj</code></h3>


 <p>Let&rsquo;s create a Racket wrapper function for the <a href="http://git.openssl.org/gitweb/?p=openssl.git;a=blob;f=crypto/sha/sha.h;h=8a6bf4bbbb1dbef37869fc162ce1c2cacfebeb1d;hb=46ebd9e3bb623d3c15ef2203038956f3f7213620#l155" title="OpenSSL source: crypto/sha/sha.h"><code>SHA256</code></a> C function. Here&rsquo;s the header:</p>


 <div class="brush: C">

  <table class="sourcetable">

   <tbody>

    <tr>

     <td class="linenos">

      <div class="linenodiv">

       <pre>1</pre></div></td>

     <td class="code">

      <div class="source">

       <pre>unsigned char *SHA256( const unsigned char *d, size_t n, unsigned char *md );
</pre></div>
</td></tr></tbody></table>
</div>


 <p>To create a Racket wrapper function, we use <a href="http://docs.racket-lang.org/foreign/Loading_Foreign_Libraries.html?q=get-ffi-obj#%28def._%28%28lib._ffi%2Funsafe..rkt%29._get-ffi-obj%29%29" title="Racket docs: get-ffi-obj"><code>get-ffi-obj</code></a>. Here&rsquo;s one possible way to define a Racket <code>sha256</code> function that calls the C <code>SHA256</code> function:</p>


 <div class="brush: racket">

  <table class="sourcetable">

   <tbody>

    <tr>

     <td class="linenos">

      <div class="linenodiv">

       <pre>1
2
3
4
5
6
7</pre></div></td>

     <td class="code">

      <div class="source">

       <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a> </span><span class="nv">sha256</span>
  <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/Loading_Foreign_Libraries.html#(def._((lib._ffi/unsafe..rkt)._get-ffi-obj))" style="color: inherit">get-ffi-obj</a></span>
    <span class="ss">'SHA256</span> <span class="nv">libcrypto</span>
    <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="p">[</span><span class="nf">input</span>     <span class="nv">:</span> <span class="nv"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__bytes))" style="color: inherit">_bytes</a></span><span class="p">]</span>
          <span class="p">[</span><span class="nf">input-len</span> <span class="nv">:</span> <span class="nv"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__ulong))" style="color: inherit">_ulong</a></span> <span class="nv"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/bytestrings.html#(def._((quote._~23~25kernel)._bytes-length))" style="color: inherit">bytes-length</a> </span><span class="nv">input</span><span class="p">)]</span>
          <span class="p">[</span><span class="nf"><a href="http://docs.racket-lang.org/scribble-pp/text.html#(def._((lib._scribble/text..rkt)._output))" style="color: inherit">output</a></span>    <span class="nv">:</span> <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__bytes))" style="color: inherit">_bytes</a></span> <span class="nv">o</span> <span class="nv">SHA256-DIGEST-LEN</span><span class="p">)]</span>
          <span class="nv"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__bytes))" style="color: inherit">_bytes</a></span> <span class="nv">o</span> <span class="nv">SHA256-DIGEST-LEN</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>


 <p>The first argument to <code>get-ffi-obj</code> is the name of the C function and the second is the library hook that we created with <code>ffi-lib</code> earlier. The third argument is the type, which specifies how to mediate between Racket and C values. <a href="http://docs.racket-lang.org/foreign/foreign_procedures.html?q=_fun#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" title="Racket docs: _fun"><code>_fun</code></a> specifies a function type and in this case the function has three arguments (each in brackets).</p>


 <p>Examining the arguments:</p>


 <ol>

  <li>

   <p>The first argument to the C <code>SHA256</code> function is an array of input bytes. Accordingly, <code>get-ffi-obj</code> specifies this with a <code>_bytes</code> type.</p></li>

  <li>

   <p>The second argument is the length of the input byte array. The <code>=</code> tells Racket how to calculate this argument automatically. This means that a caller of the Racket <code>sha256</code> function only needs to provide the input bytes and not an additional length argument.</p></li>

  <li>

   <p>The third argument is the output byte array. The <code>o</code> indicates a return pointer and <code>SHA256-DIGEST-LEN</code> is the expected number of output bytes.</p></li></ol>


 <p>Here&rsquo;s the code to define a Racket module that exports <code>sha256</code> and <code>ripemd160</code> wrapper functions. Note that the functions that call to the C functions are now named <code>sha256/bytes</code> and <code>ripemd160/bytes</code>, and these functions consume and produce bytes. We additionally define <code>sha256</code> and <code>ripemd160</code> functions which have optional keyword arguments for conversion of the input and output. These functions consume and produce hexadecimal strings by default.</p>


 <div class="brush: racket">

  <table class="sourcetable">

   <tbody>

    <tr>

     <td class="linenos">

      <div class="linenodiv">

       <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td>

     <td class="code">

      <div class="source">

       <pre><span class="kn">#lang racket/base</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a> </span><span class="nv">ffi/unsafe</span> <span class="nv">openssl/libcrypto</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a> </span><span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._only-in))" style="color: inherit">only-in</a></span> <span class="nv">openssl/sha1</span> <span class="nv">hex-string-&gt;bytes</span>
                               <span class="nv">bytes-&gt;hex-string</span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" style="color: inherit">provide</a> </span><span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._all-defined-out))" style="color: inherit">all-defined-out</a></span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a> </span><span class="nv">SHA256-DIGEST-LEN</span> <span class="mi">32</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a> </span><span class="nv">RIPEMD160-DIGEST-LEN</span> <span class="mi">20</span><span class="p">)</span>

<span class="c1">; from crypto/sha/sha.h:</span>
<span class="c1">;   unsigned <a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._char))" style="color: inherit">char</a> *SHA256(const unsigned <a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._char))" style="color: inherit">char</a> *d, size_t n, unsigned <a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._char))" style="color: inherit">char</a> *md);</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a> </span><span class="nv">sha256/bytes</span>
  <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/Loading_Foreign_Libraries.html#(def._((lib._ffi/unsafe..rkt)._get-ffi-obj))" style="color: inherit">get-ffi-obj</a></span>
  <span class="ss">'SHA256</span> <span class="nv">libcrypto</span>
  <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="p">[</span><span class="nf">input</span>     <span class="nv">:</span> <span class="nv"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__bytes))" style="color: inherit">_bytes</a></span><span class="p">]</span>
        <span class="p">[</span><span class="nf">input-len</span> <span class="nv">:</span> <span class="nv"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__ulong))" style="color: inherit">_ulong</a></span> <span class="nv"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/bytestrings.html#(def._((quote._~23~25kernel)._bytes-length))" style="color: inherit">bytes-length</a> </span><span class="nv">input</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf"><a href="http://docs.racket-lang.org/scribble-pp/text.html#(def._((lib._scribble/text..rkt)._output))" style="color: inherit">output</a></span>    <span class="nv">:</span> <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__bytes))" style="color: inherit">_bytes</a></span> <span class="nv">o</span> <span class="nv">SHA256-DIGEST-LEN</span><span class="p">)]</span>
        <span class="nv"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__bytes))" style="color: inherit">_bytes</a></span> <span class="nv">o</span> <span class="nv">SHA256-DIGEST-LEN</span><span class="p">))))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a> </span><span class="p">(</span><span class="nf">sha256</span> <span class="nv">input</span> <span class="kd">#:convert-input</span>  <span class="p">[</span><span class="nf">input-&gt;bytes</span> <span class="nv">hex-string-&gt;bytes</span><span class="p">]</span>
                      <span class="kd">#:convert-output</span> <span class="p">[</span><span class="nf">bytes-&gt;output</span> <span class="nv">bytes-&gt;hex-string</span><span class="p">])</span>
  <span class="p">(</span><span class="nf">bytes-&gt;output</span> <span class="p">(</span><span class="nf">sha256/bytes</span> <span class="p">(</span><span class="nf">input-&gt;bytes</span> <span class="nv">input</span><span class="p">))))</span>

<span class="c1">; from crypto/ripemd/ripemd.h</span>
<span class="c1">;   unsigned <a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._char))" style="color: inherit">char</a> *RIPEMD160(const unsigned <a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._char))" style="color: inherit">char</a> *d, size_t n, unsigned <a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._char))" style="color: inherit">char</a> *md);</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a> </span><span class="nv">ripemd160/bytes</span>
  <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/Loading_Foreign_Libraries.html#(def._((lib._ffi/unsafe..rkt)._get-ffi-obj))" style="color: inherit">get-ffi-obj</a></span>
  <span class="ss">'RIPEMD160</span> <span class="nv">libcrypto</span>
  <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="p">[</span><span class="nf">input</span>     <span class="nv">:</span> <span class="nv"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__bytes))" style="color: inherit">_bytes</a></span><span class="p">]</span>
        <span class="p">[</span><span class="nf">input-len</span> <span class="nv">:</span> <span class="nv"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__ulong))" style="color: inherit">_ulong</a></span> <span class="nv"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/bytestrings.html#(def._((quote._~23~25kernel)._bytes-length))" style="color: inherit">bytes-length</a> </span><span class="nv">input</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf"><a href="http://docs.racket-lang.org/scribble-pp/text.html#(def._((lib._scribble/text..rkt)._output))" style="color: inherit">output</a></span>    <span class="nv">:</span> <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__bytes))" style="color: inherit">_bytes</a></span> <span class="nv">o</span> <span class="nv">RIPEMD160-DIGEST-LEN</span><span class="p">)]</span>
        <span class="nv"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="p">(</span><span class="nf"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__bytes))" style="color: inherit">_bytes</a></span> <span class="nv">o</span> <span class="nv">RIPEMD160-DIGEST-LEN</span><span class="p">))))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a> </span><span class="p">(</span><span class="nf">ripemd160</span> <span class="nv">input</span> <span class="kd">#:convert-input</span>  <span class="p">[</span><span class="nf">input-&gt;bytes</span> <span class="nv">hex-string-&gt;bytes</span><span class="p">]</span>
                         <span class="kd">#:convert-output</span> <span class="p">[</span><span class="nf">bytes-&gt;output</span> <span class="nv">bytes-&gt;hex-string</span><span class="p">])</span>
  <span class="p">(</span><span class="nf">bytes-&gt;output</span> <span class="p">(</span><span class="nf">ripemd160/bytes</span> <span class="p">(</span><span class="nf">input-&gt;bytes</span> <span class="nv">input</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>


 <h3 id="testing">Testing</h3>


 <p>To test our wrapper functions, let&rsquo;s see if we can duplicate <a href="https://en.bitcoin.it/wiki/Technical_background_of_version_1_Bitcoin_addresses" title="Bitcoin Wiki: Technical background of version 1 Bitcoin addresses">this example</a>, which converts a Bitcoin private key into an address. We covered <a href="http://www.lostintransaction.com/blog/2014/03/14/deriving-a-bitcoin-public-key-from-a-private-key/" title="Deriving a Bitcoin Public Key From a Private Key">how to calculate a public key from a private key</a> in a previous post, so we start with the public key here.</p>


 <p>For ease of comparison, here&rsquo;s the sequence of expected hashes, copied from the Bitcoin wiki example:</p>


 <ol>

  <li>public key: <code>0450863AD64A87AE8A2FE83C1AF1A8403CB53F53E486D8511DAD8A04887E5B23522CD470243453A299FA9E77237716103ABC11A1DF38855ED6F2EE187E9C582BA6</code></li>

  <li>SHA&ndash;256: <code>600FFE422B4E00731A59557A5CCA46CC183944191006324A447BDB2D98D4B408</code></li>

  <li>RIPEMD&ndash;160: <code>010966776006953D5567439E5E39F86A0D273BEE</code></li>

  <li>prepend <code>0x00</code>: <code>00010966776006953D5567439E5E39F86A0D273BEE</code></li>

  <li>SHA&ndash;256: <code>445C7A8007A93D8733188288BB320A8FE2DEBD2AE1B47F0F50BC10BAE845C094</code></li>

  <li>SHA&ndash;256 (checksum is first 4 bytes): <code>D61967F63C7DD183914A4AE452C9F6AD5D462CE3D277798075B107615C1A8A30</code></li>

  <li>checksum + #4 = (hex) address: <code>00010966776006953D5567439E5E39F86A0D273BEED61967F6</code></li></ol>


 <p>And here&rsquo;s what the computations look like with our new library (using the Racket REPL):</p>


 <pre><code>$ racket
Welcome to Racket v6.0.0.3.
-&gt; (require "crypto.rkt")
-&gt; (define pub-key "0450863AD64A87AE8A2FE83C1AF1A8403CB53F53E486D8511DAD8A04887E5B23522CD470243453A299FA9E77237716103ABC11A1DF38855ED6F2EE187E9C582BA6")
-&gt; (sha256 pub-key)
"600ffe422b4e00731a59557a5cca46cc183944191006324a447bdb2d98d4b408"
-&gt; (ripemd160 (sha256 pub-key))
"010966776006953d5567439e5e39f86a0d273bee"
-&gt; (define hash160 (ripemd160 (sha256 pub-key)))
-&gt; (define hash160/extended (string-append "00" hash160))
-&gt; (sha256 hash160/extended)
"445c7a8007a93d8733188288bb320a8fe2debd2ae1b47f0f50bc10bae845c094"
-&gt; (sha256 (sha256 hash160/extended))
"d61967f63c7dd183914a4ae452c9f6ad5d462ce3d277798075b107615c1a8a30"
-&gt; (define checksum (substring (sha256 (sha256 hash160/extended)) 0 8))
-&gt; checksum
"d61967f6"
-&gt; (define address/hex (string-append hash160/extended checksum))
-&gt; address/hex
"00010966776006953d5567439e5e39f86a0d273beed61967f6"
   </code></pre>


 <p>In the next post, I&rsquo;ll experiment with <a href="https://en.bitcoin.it/wiki/Base58Check_encoding" title="Bitcoin wiki: Base58Check encoding">Base58Check encoding</a> and decoding.</p>


 <h3 id="software">Software</h3>


 <p>In this post, I&rsquo;m using OpenSSL 1.0.1e, Racket 6.0.0.3, and running Debian 7.0.</p>

 <footer>

  <script type="text/javascript">
      !function(d,s,id){
          var js,fjs=d.getElementsByTagName(s)[0];
          if(!d.getElementById(id)){
              js=d.createElement(s);
              js.id=id;
              js.src="//platform.twitter.com/widgets.js";
              fjs.parentNode.insertBefore(js,fjs);
          }
      }(document,"script","twitter-wjs");
    </script>
    <a class="twitter-share-button" data-dnt="true" data-url="http://www.lostintransaction.com/blog/2014/03/15/adding-openssl-bindings-to-racket-via-its-ffi/" href="https://twitter.com/share">
      "Tweet"</a>

  <script src="https://apis.google.com/js/plusone.js" type="text/javascript"></script>

  <g:plusone href="http://www.lostintransaction.com/blog/2014/03/15/adding-openssl-bindings-to-racket-via-its-ffi/" size="medium"></g:plusone>

  <script type="text/javascript">
      var disqus_shortname = 'lostintransaction';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>

  <div id="disqus_thread"></div>

  <ul class="pager">


   <li class="next">
      <a href="/blog/2014/03/14/deriving-a-bitcoin-public-key-from-a-private-key/"><em>Deriving a Bitcoin Public Key From a Private Key</em> &rarr;</a>
    </li>
    </ul>
  </footer>
</article>
        </div>
      </div>
      <footer>
        <hr />
        <p>Lost in Transaction: A neophyte explores Bitcoin.</p>
        <p><a href="https://twitter.com/sixconfirms"
              class="twitter-follow-button"
              data-show-count="false"
              data-lang="en">
             "Follow sixconfirms"
           </a>
           <script type="text/javascript">
             !function(d,s,id){
                 var js,fjs=d.getElementsByTagName(s)[0];
                 if(!d.getElementById(id)){
                     js=d.createElement(s);
                     js.id=id;
                     js.src="//platform.twitter.com/widgets.js";
                     fjs.parentNode.insertBefore(js,fjs);
                 }
             }(document,"script","twitter-wjs");
           </script></p>
        <p>Site generated
        by <a href="https://github.com/greghendershott/frog">Frog</a>,
        the <strong>fr</strong>ozen bl<strong>og</strong> tool.</p>
        <p>Using <a href="http://twitter.github.com/bootstrap/index.html">Bootstrap</a>.</p>
<!--        <p><em>Your legal notice here</em>.</p>-->
        <p><em>Don't believe anything you read here</em>.</p>
        <p><a href="bitcoin:18kk6eoa8SvE1TCbfC67ToLfof4vfvNnPS">18kk6eoa8SvE1TCbfC67ToLfof4vfvNnPS</a></p>
      </footer>
    </div>
    <!-- </body> JS -->
    <script type="text/javascript" src="//code.jquery.com/jquery.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  </body>
</html>